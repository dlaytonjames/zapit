version: '2.1'
services:
  server:
    build: .
    image: isim/url-scanner
    environment:
      - HOSTNAME=server
      - PORT=${SCANNER_PORT}
      - DB_SERVICE=db
      - DB_PORT=${REDIS_PORT}
    restart: always

  lb:
    image: nginx:1.13
    ports:
      - "${SCANNER_PORT}:${SCANNER_PORT}"
    environment:
      - PORT=${SCANNER_PORT}
    command: /bin/bash -c "envsubst '$${PORT}' < /etc/nginx/conf.d/nginx.conf.tmpl > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    volumes:
      - ./bootstrap/nginx/nginx.conf.tmpl:/etc/nginx/conf.d/nginx.conf.tmpl

  db:
    image: redis:3.2.9
    ports:
      - ${REDIS_PORT}:${REDIS_PORT}
